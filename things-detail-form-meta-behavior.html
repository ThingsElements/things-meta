<link rel="import" href="../polymer/polymer.html">

<script>

window.Things = window.Things || {};

/**
 * 구성하고자 하는 리소스 화면 구성을 위해 모델 정보를 제공하는 Behavior
 * 리소스의 메타 데이터를 조회하는 URL 구성과 메타 데이터를 받은 후 검색 폼, 그리드, 디테일 폼에 필요한 모델 정보를 제공한다.
 *
 * @polymerBehavior Things.DetailFormMetaBehavior
 */
Things.DetailFormMetaBehavior = {

	properties: {
		/**
		 * Resource form fields
		 */
		resourceFormFields: {
			type: Array
		},

		/**
		 * Resource form 저장 시점에 서버에 전달되지 않기를 원하는 필드 리스트
		 */
		ignoreFieldsOnSave: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_tabindex: {
			type: Number,
			value: 1
		}
	},

	/**
	 * meta data로 부터 resourceFormFields로 파싱한다.
	 *
	 * @param {Array} metaDataList
	 * @return {Array} resourceFormFields
	 */
	_parseResourceFormFields: function(metaDataList) {
		var me = this;
		return metaDataList.map(function(metaData) {
			var field = { 
				name : metaData.name, 
				label : Things.DataGlobal.tt(metaData.term),
				type : metaData.form_editor
			};
			field.tabindex = me.setTabindex(metaData.form_editor,metaData);

			if(metaData.ignore_on_save) me.ignoreFieldsOnSave.push(metaData.name);
			if(!metaData.form_editor) metaData.form_editor = 'text';
			me._parseResourceFormField(field, metaData, true);
			return field;
		});		
	},
	/**
	 * text/number/password/textarea/code-combo/resource-combo에는 tabindex를 주고 
	 * 남은 에디터는 tabIndex를 주지 않는다.
	 * 
	 * @param {[type]} editorType [description]
	 * @param {[type]} metaData   [description]
	 */
	setTabindex : function(editorType,metaData){
		if(editorType =='text'||editorType =='number'||editorType =='password'||
		   editorType =='textarea'||editorType=='code-combo'||editorType =='resource-combo'){
			return 0
		}else{
			return -1
		}
	},
	/**
	 * form field를 파싱한다.
	 *
	 * @param {Object} field
	 * @param {Object} metaData
	 * @param {Boolean} resourceForm resourceForm인지 아닌지 여부 
	 */
	_parseResourceFormField: function(field, metaData, resourceForm) {
		var editor = metaData.form_editor;

		if('code-combo' == editor) {
			field.codeName = metaData.ref_name;

		} else if(editor.indexOf('resource-selector') >= 0 || 
							editor.indexOf('resource-format-selector') >= 0 || 
							editor.indexOf('resource-field') >= 0 || 
							editor.indexOf('resource-combo') >= 0) {
			field.userData = {
				resourceType : metaData.ref_type,
				resourceName : metaData.ref_name,
				initialParams : metaData.ref_params,
				bindFields : metaData.ref_related,
				submitName : field.name
			};
			
			if(editor.indexOf('.') > 0) {
				var editorSplitArr = editor.split('.');
				field.type = editorSplitArr[0];
				field.userData.delegateColumn = editorSplitArr[1];
			} else {
				field.type = editor;
			}

			if(resourceForm && field.type == 'resource-selector') {
				field.type = 'resource-field';
			}

			if(field.type == 'resource-field') {
				field.name = field.name.indexOf('_id') > 0 ? field.name.substr(0, field.name.indexOf('_id')) : field.name;
			}

			if(field.type == 'resource-combo') {
				field.userData.delegateColumn = metaData.form_format ? metaData.form_format : 'id';
			}

			if(field.type == 'resource-format-selector') {
				field.userData.delegateColumn = metaData.form_format ? metaData.form_format : 'name';
			}
			
		} else if ('number' == editor) {
			field.userData = { type : metaData.col_type };

		} else if('text' == editor) {
			field.userData = { type : metaData.col_type };
			if(!metaData.nullable) field.userData.required = true;
			if(metaData.col_size && metaData.col_size > 0) field.userData.max = metaData.col_size;
			if(metaData.form_validator) {
				field.userData.validator = metaData.form_validator.replace('things.', 'things-validator-'); 
			}

		} else if('date-from-to-picker' == editor) {
			field.userData = { defaultRange : metaData.def_val };

		} else if('hidden' == editor) {
			field.userData = { hidden: true };
			
		} else if('readonly' == editor) {
			field.userData = { readonly: true };
		}

		if(metaData.def_val) {
			field.default = metaData.def_val;
		}
	}
};

</script>
