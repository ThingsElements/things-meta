<link rel="import" href="../polymer/polymer.html">

<script>

window.Things = window.Things || {};

/**
 * 구성하고자 하는 리소스 화면 구성을 위해 모델 정보를 제공하는 Behavior
 * 리소스의 메타 데이터를 조회하는 URL 구성과 메타 데이터를 받은 후 검색 폼, 그리드, 디테일 폼에 필요한 모델 정보를 제공한다.
 *
 * @polymerBehavior Things.GridMetaBehavior
 */
Things.GridMetaBehavior = {

  properties: {
    /**
     * Grid Config
     */
    gridConfig: {
      type: Object
    },

    /**
     * Grid model
     */
    gridModel: {
      type: Array
    },

    /**
     * Grid columns
     */
    gridColumns: {
      type: Array
    },

    /**
     * Buttons
     */
    buttons: {
      type: Array
    }
  },

  /**
   * meta data로 부터 buttons를 파싱한다.
   *
   * @param {Array} buttonList
   * @return {Array} buttonList
   */
  _parseButtons: function(buttonList) {
    if(buttonList) { 
      buttonList.forEach(function(button) { button.id = button.text + '-btn'; }); 
    }
    
    return buttonList;
  },  

  /**
   * meta data로 부터 gridModel로 파싱한다.
   *
   * @param {Array} metaDataList
   * @return {Array} gridModel
   */
  _parseGridModel: function(metaDataList) {
    var gridModelMetaList = metaDataList.filter(function(metaData) { 
      if(metaData.name == 'id' && !metaData.grid_rank) metaData.grid_rank = -10;
      return metaData.grid_rank && metaData.grid_rank != 0;
    });

    var selectColumns = '';

    var gridModel = gridModelMetaList.map(function(metaData) {
      var field = { fieldName : metaData.name };

      if(['integer', 'int', 'long', 'double', 'float'].includes(metaData.col_type)) {
        field.dataType = 'number';

      } else if(['date', 'time'].includes(metaData.col_type)) {
        field.dataType = 'datetime';
        field.datetimeFormat = metaData.grid_format? metaData.grid_format : 'yyyy-MM-dd';
      }

      var editor = metaData.grid_editor;

      if(editor && editor.indexOf('resource-column') >= 0) {
        field.fieldName = field.fieldName.substr(0, field.fieldName.indexOf('_id'));
        field.dataType = 'object';
      }

      if(editor && editor.indexOf('resource-selector') >= 0) {
        field.fieldName = field.fieldName.substr(0, field.fieldName.indexOf('_id'));
        field.dataType = 'object';
      }

      if(editor && editor.indexOf('resource-format-selector') >= 0) {
        if(field.fieldName.indexOf('_id') >= 0) {
          field.fieldName = field.fieldName.substr(0, field.fieldName.indexOf('_id'));
        }

        field.dataType = 'object';
      }

      if(!field.dataType) field.dataType = 'string';

      if(field.dataType != 'object' && metaData.def_val) {
        field.defaultValue = (field.dataType == 'number') ? Number(metaData.def_val) : metaData.def_val;
      }

      if(selectColumns.length > 2) {
        this.selectFields = selectColumns.substr(0, selectColumns.length - 1);  
      }

      selectColumns += field.fieldName + ',';
      return field;
    });

    if(selectColumns.length > 2) {
      this.selectFields = selectColumns.substr(0, selectColumns.length - 1);  
    }

    return gridModel;
  },

  /**
   * meta data로 부터 gridColumns로 파싱한다.
   *
   * @param {Array} metaDataList
   * @return {Array} gridColumns
   */
  _parseGridColumns: function(metaDataList) {
    var gridColumnMetaList = metaDataList.filter(function(metaData) { 
      return metaData.grid_rank && metaData.grid_rank != 0;
    });

    this._sortMetaData(gridColumnMetaList, 'grid_rank');
    // resource selector 컬럼 
    //var me = this, resourceSelectorColumns = [];
    var me = this;

    var gColumns = gridColumnMetaList.map(function(metaData) {
      var field = { 
        name: metaData.name, 
        fieldName: metaData.name, 
        width: metaData.grid_width ? metaData.grid_width : 100,
        header: { text: Things.DataGlobal.tt(metaData.term) },
        styles: {},
        validations: []
      };

      // id 필드는 기본으로 grid_width를 0으로 하고 숨기지만 표시한다고 설정이 되어 있으면 설정한다. 어쨋든 그리드 상에는 존재해야 한다.
      if(metaData.name == 'id') {
        field.width = metaData.grid_rank > 0 ? metaData.grid_width : 0;
      }

      // align 정보가 있으면 설정
      if(metaData.grid_align) field.styles.textAlignment = metaData.grid_align;

      var editor = metaData.grid_editor;
      if(editor) {
        if(('code-combo' == editor) && metaData.code_list && metaData.code_list.length > 0) {
          field.editor = { type: 'list', domainOnly: true };
          field.lookupDisplay = true;
          field.lookupValues = metaData.code_list.map(function(code) { return code.name });
          field.lookupValues.unshift('');
          field.lookupLabels = metaData.code_list.map(function(code) { return code.description });
          field.lookupLabels.unshift('');

        } else if(editor == 'checkbox') {
          field.editable = false;
          field.renderer = { type: 'check', editable: true, threeStates: false, trueValues: 'true', falseValues: 'false' };

        } else if(editor == 'number') {
          field.editor = { type: 'number' };
          field.styles.numberFormat = metaData.grid_format ? metaData.grid_format : '0,000';

        } else if(editor == 'date-picker' || editor == 'time-picker') {
          field.editable = false;
          field.styles.iconIndex = 'date-picker';
          field.styles.datetimeFormat = metaData.grid_format ? metaData.grid_format : 'yyyy-MM-dd';
          field.styles.textAlignment = 'center';

        } else if(editor.indexOf('resource-column') >= 0) {
          me._newResourceColumn(metaData, field);

        } else if(editor.indexOf('resource-selector') >= 0) {
        	me._newResourceColumn(metaData, field);
          field.editable = false;
          field.styles.iconIndex = 'resource-selector';
          field.userObj = {
            resourceType: metaData.ref_type,
            resourceName: metaData.ref_name,
            initialParams : metaData.ref_params,
            ownerField: field.name,
            bindFields: metaData.ref_related
          };
          //me._setResourceEditorColumn(metaData, field, resourceSelectorColumns);

        } else if(editor.indexOf('resource-format-selector') >= 0) {
          field.editable = false;
          field.styles.iconIndex = 'resource-format-selector';
          field.userObj = {
            resourceType: metaData.ref_type,
            resourceName: metaData.ref_name,
            initialParams : metaData.ref_params,
            ownerField: field.name,
            bindFields: metaData.ref_related,
            valueField: metaData.grid_format
          };

        } else if (editor.indexOf('image-selector') >= 0) {
          field.editable = false;
          field.styles.iconIndex = 'image-selector';
          
        } else if(editor == 'download-link') {
          field.renderer = {
            type: 'link',
            requiredFields: 'id',
            showUrl: true,
            url: (metaData.grid_format ? metaData.grid_format : '') + "/${id}"
          }

        } else if(editor == 'hidden') {
          field.width = 0;

        } else if(editor == 'readonly') {
          field.editable = false;

        } else {
          if(metaData.col_size && metaData.col_size > 0 && metaData.col_type == 'string') {
            field.editor = { maxLength : metaData.col_size };
          }
        }
      }

      if(metaData.name != 'id' && !metaData.nullable) {
        field.validations.push({
          level: 'error', 
          expression : 'value is not empty',
          message: Things.DataGlobal.t('error.SHOULD_NOT_BE_EMPTY', { 
            value : Things.DataGlobal.tt(metaData.term) 
          })
        });
      }

      if(metaData.col_size && metaData.col_size > 0 && metaData.col_type == 'string') {
        field.validations.push({
          level: 'error', 
          expression : 'len value < ' + metaData.col_size, 
          message: Things.DataGlobal.t('error.MAX_LENGTH_OF_X_IS_Y', { 
            name : Things.DataGlobal.tt(metaData.term), value : metaData.col_size
          })
        });
      }

      return field;
    });

    // Resource Selector가 있을 경우 컬럼 추가 
    /*if(resourceSelectorColumns.length > 0) {
      resourceSelectorColumns.forEach(function(rec) {
        var oriFieldName = rec.fieldName.substr(0, rec.fieldName.indexOf('_id'));
        var foundFields = gColumns.filter(function(col) { return col.name == oriFieldName});
        var foundIdx = gColumns.indexOf(foundFields[0]);
        gColumns.splice(foundIdx + 1, 0, rec);
      });
    }*/

    return gColumns;
  },

  /**
   * resource column
   *
   * @param {Object} metaData
   * @param {Object} field
   */
  _newResourceColumn: function(metaData, field) {
    var titleField = metaData.grid_format ? metaData.grid_format : 'name';
    field.userData = { titleField : titleField };
    field.name = field.name.substr(0, field.name.indexOf('_id'));
    field.fieldName = field.name;

    // 1. Object 형식의 데이터를 화면에 표시하기 위한 콜백 함수 
    field.displayCallback = function(index, value) {
      var rowObj = index.getRow().getRowObject();
      var fieldName = index.column.dataFieldName();
      var userData = index.column.userData();
      var columnObj = rowObj[fieldName];
      var retVal = columnObj ? columnObj[userData.titleField] : '';
      return retVal;
    };

    /*field.valueType = 'text';
    field.type = 'calced';
    field.valueCallback = function(column, row) {
      var userData = column.userData();
      var titleField = userData.titleField;
      var obj = row.getValue(column.name());
      return obj ? obj[titleField] : '';
    };*/

    // 2. Object 형식의 데이터를 Text 형식으로 클립보드에 전달 
    field.copyCallback = function (row, field, value) {
      var strValue = value ? JSON.stringify(value) : value;
      return strValue;
    };

    // 3. Text 형식으로 전달된 클립보드 데이터를 전달받아 Paste Logic 수행 
    field.pasteCallback = function(row, field, value) {
      var rowObj = row.getRowObject();
      var resourceObj = value ? JSON.parse(value) : value;
      rowObj[field.fieldName()] = resourceObj;
      return field.readValue(resourceObj);
    }
  },

  /**
   * resource editor column 설정 
   *
   * @param {Object} metaData
   * @param {Object} field
   * @param {Array} resourceSelectorColumns
   */
  /*_setResourceEditorColumn: function(metaData, field, resourceSelectorColumns) {
    var editorField = {
      name: metaData.name, 
      fieldName: metaData.name, 
      header: { text: ' ' },
      width: 30,
      editable: false,
      header: { text: '...' },
      imageList: 'images',
      renderer: {
        type: 'icon'
      },
      styles: {
        iconIndex: 'menu_button.png',
        iconLocation: 'center'
      },
      userObj: {
        resourceType: metaData.ref_type,
        resourceName: metaData.ref_name,
        initialParams : metaData.ref_params,
        ownerField: field.name,
        bindFields: metaData.ref_related
      }
    };

    resourceSelectorColumns.push(editorField);
  },*/

  /**
   * list sorting
   */
  _sortMetaData: function(list, sortField) {
    list.sort(function(a, b) {
      return (a[sortField] > b[sortField]) ? 1 : ((b[sortField] > a[sortField]) ? -1 : 0);
    });
  }
};

</script>